<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Practice — SSB Prep (Screening)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="SSB screening: OIR & PPDT workflows with optional Hugging Face integration.">

  <style>
  :root{--accent:#0366d6;--muted:#6b7280;--card:#fff}
  body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; margin:0; background:#f6f7fb; color:#111}
  .container{max-width:1100px;margin:0 auto;padding:18px;box-sizing:border-box}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  a.logo{font-weight:700;color:var(--accent);text-decoration:none}
  .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:12px}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:14px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  h1{margin:0 0 6px 0;font-size:20px}
  label{display:block;font-weight:600;margin-bottom:6px}
  textarea, input[type="text"], input[type="password"], select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e6e9;box-sizing:border-box;font-family:inherit}
  .small{font-size:13px;color:var(--muted)}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  .btn-muted{background:#6b7280;color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .preview{border:1px solid #eee;border-radius:8px;padding:10px;background:#fbfbfe;min-height:150px;display:flex;align-items:center;justify-content:center}
  .timer{font-weight:700;font-size:26px;margin-top:8px}
  .hidden{display:none}
  .large-option{display:flex;flex-direction:column;gap:10px}
  .big-btn{padding:18px;border-radius:12px;background:#fff;border:1px solid #e6e6ef;cursor:pointer;text-align:center;font-weight:700}
  .locked-overlay{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(255,255,255,0.85);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px}
  .muted{color:var(--muted)}
  .section{margin-bottom:12px}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a class="logo" href="index.html">← SSB Prep Home</a>
      <div id="authArea"></div>
    </header>

    <main>
      <!-- Auth gate -->
      <div id="authGate" class="card">
        <h1>Sign in to access Screening</h1>
        <p class="small muted">Local sign-in for personal use. Credentials are stored in your browser only.</p>
        <div style="margin-top:10px">
          <label>Username</label>
          <input id="loginUser" type="text" placeholder="your-username" />
        </div>
        <div style="margin-top:10px">
          <label>Passphrase</label>
          <input id="loginPass" type="password" placeholder="enter passphrase" />
        </div>
        <div style="margin-top:10px" class="row">
          <button id="btnLogin" class="btn">Sign in</button>
          <button id="btnUseDemo" class="btn-muted">Use demo credentials</button>
        </div>
      </div>

      <!-- Main content (hidden until login) -->
      <div id="appArea" class="hidden">
        <!-- Big choice landing: OIR vs PPDT -->
        <section id="landing" class="card">
          <h1 style="margin-top:0">Screening — Choose a test</h1>
          <p class="small muted">Select the test you want to attempt. Each selection opens a dedicated flow. We'll implement OIR and PPDT now.</p>

          <div class="large-option" style="margin-top:12px">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <button id="goOIR" class="big-btn" style="min-height:120px">OIR<br><span class="small muted" style="font-weight:600">Observation & Questions</span></button>
              <button id="goPPDT" class="big-btn" style="min-height:120px">PPDT<br><span class="small muted" style="font-weight:600">Picture Perception & Description Test</span></button>
            </div>
          </div>
        </section>

        <!-- OIR area -->
        <section id="oirArea" class="card hidden">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h2 style="margin:0">OIR — Observation & Questions</h2><div class="small muted">Paste generated Q&A or use sample to start.</div></div>
            <div><button id="backFromOir" class="btn-muted">Back</button></div>
          </div>

          <div style="margin-top:12px">
            <label>Instructions</label>
            <div class="small muted">If you have a Hugging Face text-generation output, paste it in the box below. Otherwise click "Load sample". Then press "Start Test".</div>
            <textarea id="oirInput" rows="8" placeholder="Paste generated OIR Q&A here..."></textarea>
            <div class="row" style="margin-top:8px">
              <button id="loadSampleOir" class="btn-muted">Load sample</button>
              <button id="startOirTest" class="btn">Start Test</button>
            </div>
          </div>

          <div id="oirTestWindow" style="margin-top:12px"></div>
        </section>

        <!-- PPDT configuration and flow -->
        <section id="ppdtArea" class="card hidden">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h2 style="margin:0">PPDT — Configuration</h2><div class="small muted">Choose gender, test type and options. Then click Start Test to auto-generate image and begin.</div></div>
            <div><button id="backFromPpdt" class="btn-muted">Back</button></div>
          </div>

          <div style="margin-top:12px" class="grid">
            <div>
              <label>Gender</label>
              <select id="ppdtGender">
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>

              <label style="margin-top:10px">Test Type</label>
              <div class="row">
                <label><input type="radio" name="ppdtTimed" value="timed" checked> Timed</label>
                <label><input type="radio" name="ppdtTimed" value="untimed"> Untimed</label>
              </div>

              <div id="timedOptions" style="margin-top:10px">
                <label>Duration (seconds) for observation (default 60)</label>
                <input id="obsDuration" type="number" value="60" min="10" max="600" />
                <label style="margin-top:8px">Show timer to candidate?</label>
                <div class="row"><label><input type="checkbox" id="showTimer" checked> Show timer</label></div>
              </div>

              <label style="margin-top:10px">PPDT Prompt</label>
              <textarea id="ppdtPrompt" rows="4">PPDT-style: a blurred photograph of a dusty village road at dusk with a damaged bicycle and two men arguing near a tea stall; a mini-van parked nearby; ambiguous mood; realistic photo; 4:3</textarea>

              <div style="margin-top:10px" class="row">
                <button id="startPpdtTest" class="btn">Start Test (auto-generate image)</button>
                <button id="openImgSpace" class="btn-muted">Open HF Space (manual)</button>
              </div>

              <div style="margin-top:8px" class="small muted">Note: To auto-generate an image you must paste your Hugging Face API key on the right panel.</div>
            </div>

            <div>
              <div class="card">
                <h4 style="margin:0">Hugging Face / Tools</h4>
                <label style="margin-top:8px">HF API Key (paste here to enable automatic generation)</label>
                <input id="hfKey" type="text" placeholder="hf_xxx (optional)" />
                <div style="margin-top:8px" class="row">
                  <button id="openImgSpace2" class="btn">Open Stable Diffusion Space</button>
                  <button id="openTextSpace" class="btn-muted">Open Text Space</button>
                </div>
                <p class="small muted" style="margin-top:8px">If you do not have a key use the Space link, generate the image manually and upload it in the next step below.</p>
              </div>

              <div class="card" style="margin-top:12px">
                <h4 style="margin:0">Quick prompts</h4>
                <textarea id="quickPpdtPrompt" rows="3">PPDT-style: a blurred photograph of a dusty village road at dusk with a damaged bicycle and two men arguing near a tea stall; a mini-van parked nearby; ambiguous mood; realistic photo; 4:3</textarea>
                <div style="margin-top:8px" class="row">
                  <button id="copyQuickPrompt" class="btn">Copy prompt</button>
                </div>
              </div>
            </div>
          </div>

          <!-- PPDT runtime area (image, observation, story, recording) -->
          <div id="ppdtFlow" class="hidden" style="margin-top:12px">
            <div id="ppdtImageArea" class="card">
              <h4 style="margin:0">Generated image</h4>
              <div id="ppdtImagePreview" class="preview" style="margin-top:8px"><span class="muted">Waiting for image...</span></div>
              <div style="margin-top:8px" class="row">
                <button id="downloadPpdtImage" class="btn" disabled>Download image</button>
                <button id="uploadPpdtImage" class="btn-muted">Upload custom image</button>
                <input id="ppdtFileInput" type="file" accept="image/*" class="hidden" />
              </div>
            </div>

            <div id="obsSection" class="card hidden" style="margin-top:12px">
              <h4 style="margin:0">Observation</h4>
              <div id="obsInstruction" class="small muted">You will have the configured observation time. Do not navigate away. Fill the fields after observation finishes (if timed).</div>

              <div id="obsTimerWrap" style="margin-top:8px" class="hidden">
                <div class="timer" id="obsTimerDisplay">00:00</div>
              </div>

              <div style="margin-top:8px">
                <label>Action / what is happening?</label>
                <input id="obsAction" type="text" />
                <label style="margin-top:8px">Number of characters seen</label>
                <input id="obsCount" type="text" />
                <label style="margin-top:8px">Age groups (approx)</label>
                <input id="obsAges" type="text" />
                <label style="margin-top:8px">Main hero (who?)</label>
                <input id="obsHero" type="text" />
                <label style="margin-top:8px">Mood of characters</label>
                <input id="obsMood" type="text" />
              </div>

              <div style="margin-top:8px" class="row">
                <button id="proceedToStory" class="btn">Proceed to Story Writing</button>
              </div>
            </div>

            <div id="storySection" class="card hidden" style="margin-top:12px">
              <h4 style="margin:0">Story Writing</h4>
              <div class="small muted">Write your story based on observation.</div>
              <div id="storyTimerWrap" style="margin-top:8px" class="hidden">
                <div class="timer" id="storyTimerDisplay">00:00</div>
              </div>
              <div style="margin-top:8px" class="row">
                <button id="startStoryBtn" class="btn">Start Story Timer</button>
                <button id="finishStoryBtn" class="btn-muted">Finish Writing</button>
              </div>
              <label style="margin-top:8px">Story</label>
              <textarea id="storyText" rows="8"></textarea>
            </div>

            <div id="recordSection" class="card hidden" style="margin-top:12px">
              <h4 style="margin:0">Narration Recording (1 minute)</h4>
              <div class="small muted">Click Start Recording to begin. Recording will start immediately and run for 60s.</div>
              <div style="margin-top:8px" class="row">
                <button id="startRecordingBtn" class="btn">Start Recording</button>
                <button id="downloadRecordingBtn" class="btn-muted" disabled>Download</button>
              </div>
              <div id="recPreviewWrap" style="margin-top:8px" class="hidden">
                <video id="recPreview" controls style="width:100%;border-radius:8px"></video>
                <div style="margin-top:8px">
                  <button id="playAudioOnly" class="btn">Play audio only</button>
                  <button id="playMutedVideo" class="btn-muted">Play muted video</button>
                  <button id="playWithAV" class="btn">Play audio+video</button>
                </div>
                <label style="margin-top:8px">Self-assessment notes</label>
                <textarea id="selfNotes" rows="4"></textarea>
              </div>
            </div>
          </div>

        </section>

        <footer class="small muted">Data is stored locally. Keep this device secure.</footer>
      </div>
    </main>
  </div>

  <!-- Locked overlay used to prevent user interaction during test -->
  <div id="lockedOverlay" class="locked-overlay hidden">
    <div style="font-weight:700;font-size:18px">Test in progress — please wait</div>
    <div class="small muted">Do not refresh or close the tab. The test will finish automatically.</div>
  </div>

<script>
/* ---------------- Authentication ---------------- */
const authArea = document.getElementById('authArea');
const authGate = document.getElementById('authGate');
const appArea = document.getElementById('appArea');
function isLoggedIn(){ return !!localStorage.getItem('ssb_user'); }
function showAuthState(){
  if(isLoggedIn()){
    const u = JSON.parse(localStorage.getItem('ssb_user'));
    authArea.innerHTML = `<div class="small muted">Signed in as <strong>${u.username}</strong> &nbsp; <button id="signoutBtn" class="btn-muted">Sign out</button></div>`;
    authGate.classList.add('hidden');
    appArea.classList.remove('hidden');
    document.getElementById('signoutBtn').addEventListener('click', ()=> { localStorage.removeItem('ssb_user'); showAuthState(); });
  } else {
    authArea.innerHTML = '';
    authGate.classList.remove('hidden');
    appArea.classList.add('hidden');
  }
}
showAuthState();

document.getElementById('btnLogin').addEventListener('click', ()=> {
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  if(!u || !p){ alert('Enter both username and passphrase'); return; }
  localStorage.setItem('ssb_user', JSON.stringify({username: u, created: Date.now()}));
  showAuthState();
});
document.getElementById('btnUseDemo').addEventListener('click', ()=> {
  localStorage.setItem('ssb_user', JSON.stringify({username: 'demo_user', created: Date.now()}));
  showAuthState();
});

/* ---------------- Landing buttons ---------------- */
document.getElementB
